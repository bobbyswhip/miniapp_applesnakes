# X402 Verified Launcher - Wallet Fix Implementation Guide

## The Problem

The "Insufficient USDC balance. Have: $0, Need: $1" error was caused by a **wallet address mismatch**:

| What | Old (Wrong) | New (Correct) |
|------|-------------|---------------|
| Payment Wallet | `0xE5E9108B4467158C498E8C6b6E39Ae12F8b0A098` | `0xa825094B04D5a3710bd41C4fbC902F75cF333333` |
| Source | `AI_WALLET` (no private key) | `ADMIN_WALLET` (we have private key) |

**Result**: Users were signing USDC transfers to the wrong address. The server tried to swap from `ADMIN_WALLET` which had $0 USDC.

## Backend Fix (Already Deployed)

Changed `app/api/verified-launcher/verify/route.ts`:
```typescript
// OLD (wrong)
import { getAIWalletAddress } from "@/lib/usdc-swap-client";
const AI_WALLET = getAIWalletAddress() as Address;

// NEW (correct)
import { getAdminWalletAddress } from "@/lib/usdc-swap-client";
const PAYMENT_WALLET = getAdminWalletAddress() as Address;
```

Both `/api/verified-launcher/verify` and `/api/verified-launcher/launch` now return:
```json
{
  "payTo": "0xa825094B04D5a3710bd41C4fbC902F75cF333333"
}
```

---

## Frontend - What You Need to Check

### The x402 client already fetches `payTo` dynamically!

Looking at `lib/x402-verified-client.ts` lines 329-380, the client:

1. Makes initial request to API
2. Gets 402 response with `accepts[0].payTo`
3. Uses that `payTo` address in the signature

```typescript
// Line 346-354 - Gets payTo from server response
const accepts = paymentData.accepts?.[0];
// ...
// Line 429 - Uses it in the message
to: accepts.payTo as `0x${string}`,
```

**This means the frontend should automatically use the new wallet address!**

---

## Why It Might Still Fail

### 1. Browser Cache
The browser might have cached the old 402 response with the wrong `payTo` address.

**Fix**: Hard refresh the page (`Ctrl+Shift+R` or `Cmd+Shift+R`)

### 2. Old Frontend Build Deployed
If you deployed the frontend separately, it might have old lib files.

**Fix**: Rebuild and redeploy the frontend:
```bash
npm run build
# Deploy to your frontend hosting
```

### 3. Different API URL
Check if the frontend is hitting the correct API:

```typescript
// In useX402VerifiedLauncher.ts line 97
apiBaseUrl: options.apiBaseUrl || 'https://api.applesnakes.com',
```

Make sure `api.applesnakes.com` points to the updated EC2 server.

---

## Quick Verification Steps

### 1. Check the API directly
```bash
curl https://api.applesnakes.com/api/verified-launcher/verify | grep payTo
```

Should return:
```
"payTo":"0xa825094B04D5a3710bd41C4fbC902F75cF333333"
```

### 2. Check browser network tab
When you try to verify/launch:
1. Open DevTools â†’ Network tab
2. Look for the 402 response
3. Check that `payTo` is `0xa825094B04D5a3710bd41C4fbC902F75cF333333`

### 3. Check the signature being signed
In browser console, look for:
```
[X402] Signing payment: { from: "0x...", to: "0xa825094B04D5a3710bd41C4fbC902F75cF333333", ... }
```

---

## If You Need to Hardcode (Not Recommended)

If for some reason dynamic fetching isn't working, you could hardcode, but this is **not recommended**:

```typescript
// lib/x402-verified-client.ts - DON'T DO THIS unless absolutely necessary
const FALLBACK_PAYMENT_WALLET = '0xa825094B04D5a3710bd41C4fbC902F75cF333333';
```

---

## Summary

| Component | Status | Action Needed |
|-----------|--------|---------------|
| Backend API | Fixed | None |
| Frontend x402 client | Dynamic | Should auto-update |
| Browser cache | Possible issue | Hard refresh |
| Frontend deployment | Check | Rebuild if separate |

The frontend client fetches `payTo` from the API response, so it should automatically use the correct wallet after the API is updated. Just make sure to clear browser cache and verify the API is returning the new address.
